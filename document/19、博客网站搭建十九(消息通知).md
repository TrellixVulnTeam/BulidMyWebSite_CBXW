19、博客网站搭建十九(消息通知)

随着文章的增多，读者也会增多，慢慢的有些读者会对文章进行留言，读者留言肯定是要看的，而读者留言目的是想让你回复他。

怎么将读者的留言呈现给正确的用户，一个个去找也不太现实。给评论增加通知功能就是很流行的解决方案，比如朋友圈微信留言通知，以及各种社交的'小红点'.

这里我们将使用`django-notifications`为基础，非常高效的搭建一个简易的通知系统。

## 发送通知
安装`django-notifications`:

	(env) AdministratordeiMac:myblog administrator$ pip install django-notifications-hq
	
注册app：

```
INSTALLED_APPS = [
...
    'notifications'
]
```

在根路由中安装路径：

```
import notifications.urls

urlpatterns = [
...
    path('inbox/notifications/', include(notifications.urls, namespace='notifications')),
]
```
> 注意这里`notifications.url`没有像之前一样字符串，是为了确保模块安装到正确的命名空间中。

数据迁移：

	(env) AdministratordeiMac:myblog administrator$ python manage.py migrate

app安装好了，接下来就是如果在项目中的任何地方发送通知了，就像这样：

```
from notifications.singles import notify

notify.send(actor, recipinter, verb, target, action_object)
```
其中的参数释义：

* `actor`:发送通知的对象
* `recipient`：接受通知的对象
* `verb`: 动词短语
* `target`：链接到动作的对象（可选）
* `action_object`: 执行通知的对象（可选）

举个栗子：**寒江雪**(`action`)在**个人博客**（`target`）中对**你**（`recipient`）**发表了**(`verb`)**评论**(`action_object`).

因为我们想要在用户评论的时候发送通知，因此修改一下发表评论的视图，进入视图`comment/views.py`：

```
from notifications.signals import notify
from django.contrib.auth.models import User

...
def post_comment(...):
    ...

    # 已有代码，创建新回复
    if comment_form.is_valid():
        ...

        # 已有代码，二级回复
        if parent_comment_id:
            ...

            # 新增代码，给其他用户发送通知
            if not parent_comment.user.is_superuser:
                notify.send(
                    request.user,
                    recipient=parent_comment.user,
                    verb='回复了你',
                    target=article,
                    action_object=new_comment,
                )

            return HttpResponse('200 OK')

        new_comment.save()

        # 新增代码，给管理员发送通知
        if not request.user.is_superuser:
            notify.send(
                    request.user,
                    recipient=User.objects.filter(is_superuser=1),
                    verb='回复了你',
                    target=article,
                    action_object=new_comment,
                )

        return redirect(article)
...
```
> 增加了两条`notify`语句，分别位于两个if语句中：
> 
> * 第一个`notify`：用户之间可以相互评论，因此需要发送通知。if语句也是为了防止管理员收到重复的通知。
> * 第二个`notify`:所有的评论都会给管理员(也就是博主)发送通知，除了管理员自己。

>其他的代码没有变化，注意位置不要错就行了。你可以试着发送几条评论，然后打开SQLiteStudio，查看notifications_notification表中的数据变化。

## 小红点
后台创建通知的逻辑已经写好了，如上如果不能在前端显示出来，那也没起到什么作用。

而前端显示消息通知比较流行的就是“小红点”。流行的都已经泛滥了，进入很多软件其实根本都不需要。另一种形式的消息就是徽章，即 一个红色方框中带有消息条目的计数。这两种方式都会用到博客页面中。

在位置的选择上，`header`是很合适的，因为它在博客位置都会显示，很符合通知本身的定位。因此修改`templates/header.html`：


