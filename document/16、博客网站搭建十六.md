16、博客网站搭建十六
前面已经实现了用Markdown语法写文章了，但是文章的评论用Markdown就不太合适了，你不能请求别人去熟悉这个语法，另外评论中通常还有表情、带字体的颜色德国功能，这些是Markdown不具备的。

因此富文本编辑器就派上用场了，开源的三方比较常见的有[kindeditor](http://kindeditor.net/demo.php), [simditor](https://github.com/istommao/django-simditor), [django-ckeditor](https://github.com/django-ckeditor/django-ckeditor)等还有其他的一些，根据自己的喜好去选择吧。

这里使用[django-ckeditor](https://github.com/django-ckeditor/django-ckeditor)富文本编辑器。

##在后台使用ckeditor
进入虚拟环境，安装ckeditor
	
	(env) AdministratordeiMac:myblog administrator$ pip install django-ckeditor

安装成功然后再setting.pu中注册app：

```
INSTALLED_APPS = [
 ...
    'ckeditor',
]
```

然后接下来修改模型，用`django-ckeditor`库自己的富文本字段`RichTextField`替换普通文本字段`TextField`，进入`comment/models.py`:


```
# 博文评论
class Comment(models.Model):
...
    body = RichTextField()
...

```
> 记得每次修改模型要迁移数据

为了方便测试，修改`comment/admin.py`文件，将评论模块注册到后台中：

```
from django.contrib import admin
from .models import Comment

admin.site.register(Comment)

```
启动服务，进入后台评论页面,然后可以看到：

![comment.png](picture16/comment.png)

> 功能相当齐全，字体、字号、颜色、链接、表情应有尽有。
> 
> 如果我们只需要部分功能怎么办呢？比如插入flash动画就用不到，另外似乎也没看到插入代码块的功能。

`ckeditor`允许你在`setting.py`中进行自定义配置，进入`mysite/setting.py`文件：

```
...
CKEDITOR_CONFIGS = {
    # django-ckeditor默认使用default配置
    'default': {
        # 编辑器宽度自适应
        'width':'auto',
        'height':'250px',
        # tab键转换空格数
        'tabSpaces': 4,
        # 工具栏风格
        'toolbar': 'Custom',
        # 工具栏按钮
        'toolbar_Custom': [
            # 表情 代码块
            ['Smiley', 'CodeSnippet'], 
            # 字体风格
            ['Bold', 'Italic', 'Underline', 'RemoveFormat', 'Blockquote'],
            # 字体颜色
            ['TextColor', 'BGColor'],
            # 链接
            ['Link', 'Unlink'],
            # 列表
            ['NumberedList', 'BulletedList'],
            # 最大化
            ['Maximize']
        ],
        # 加入代码块插件
        'extraPlugins': ','.join(['codesnippet']),
    }
}
...
```
在`toolbar_Custom`中定义需要使用的功能模块；没列出的功能就不再显示了。代码块功能是编辑器自带的插件，需要在`extraPlugins`中指定使用。效果如下：

![snippet.png](picture16/snippet.png)

编辑富文本搞定后，还需要在前台界面中展示出来。富文本是以类似`html`的格式进行保存的，因此还需要展示评论的代码加入`|safe`过滤器，防止浏览器进行转义。

进入`templates/article/detail.html`中修改部分代码：

```
{#        显示评论#}
...
                <pre style="font-family: inherit; font-size: small">{{ commment.body|safe }}</pre>
            {% endfor %}
...
```
数显页面如下：

![commentdetail.png](picture16/commentdetail.png)

## 代码高亮
代码高亮需要额外添加插件**Prism**，在[Prism](https://ckeditor.com/cke4/addon/prism)插件官方网页下载（也可以直接点击[这里下载](https://download.ckeditor.com/prism/releases/prism_1.0.1.zip)）,将解压出来的`prism`放到`evn\lib\site-packages\ckeditor\static\ckeditor\ckeditor\plugins`目录下。注意`evn`是你创建的虚拟环境（之前安装的库都在这个目录中）。

然后再[Prism官网](https://prismjs.com/download.html#themes=prism-okaidia&languages=markup+css+clike+javascript+python&plugins=line-numbers)选择主题。

![prism.png](picture16/prism.png)

>选择自己喜欢的主题，最下面有一个预览
>
> * 根据喜好选择一个喜欢的主题
> * 然后选择需要高亮的语言。不清楚就可以全选
> * 勾选行号插件
> * 最后点击DOWNLOAD CSS下载样式

在`static`目录中新建`prism`目录，将下载好的CSS文件放进去。
> 注意之类的static是项目中的静态文件目录（与前面的章节相同）,而不是evn中的static目录

然后再需要代码高亮的模板文件中引用prism的静态文件，对代码进行渲染，进入`templates/article/detail.html`:

```
...
<script src="{% static 'ckeditor/ckeditor/plugins/prism/lib/prism/prism_patched.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'prism/prism.css' %}">
...
```
将Prism、widget、lineutils插件添加到配置文件中。后面两个编辑器自带，不用单独下载，添上就可以了：

```

CKEDITOR_CONFIGS = {
...
        # 加入代码块插件
        'extraPlugins': ','.join(['codesnippet', 'prism', 'widget', 'lineutils']),
    }
}
```
刷新页面,看到如下：

![highlightcode.png](picture16/highlightcode.png)